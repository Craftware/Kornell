{
  "Parameters": {
    "knlvpc": {
      "Type": "String"
    },

    "knlapisubnetids": {
      "Type": "String"
    },

    "knlapisgids": {
      "Type": "String"
    },

    "knljdbcurl": {
      "Type": "String"
    },

    "knljdbcdriver": {
      "Type": "String"
    },

    "knljdbcusername": {
      "Type": "String"
    },

    "knljdbcpassword": {
      "Type": "String"
    },

    "knlkeypair": {
      "Type": "AWS::EC2::KeyPair::KeyName"
    },

    "knlcertificateid": {
      "Type": "String"
    },

    "knlapiversionbucket": {
      "Type": "String",
      "Default": "us-east-1.craftware-dist"
    },

    "knlapiversionkey": {
      "Type": "String",
      "Default": "kornell/master/latest/kornell-api-eb.zip"
    },


    "knlapiinstancetype": {
      "Type": "String",
      "Default": "t2.medium",
      "AllowedValues": [
        "t2.nano",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge"
      ],
      "Description": "Enter t1.micro, m1.small, or m1.large. Default is t1.micro."
    }

  },

  "Resources": {

    "knlapiapp": {
      "Type": "AWS::ElasticBeanstalk::Application",
      "Properties": {
        "ApplicationName": {
          "Fn::Join": ["-", [{
              "Ref": "AWS::StackName"
            },
            "a"
          ]]
        },
        "Description": "Kornell API Tier"
      }
    },

    "knlapiversion": {
      "Type": "AWS::ElasticBeanstalk::ApplicationVersion",
      "Properties": {
        "Description": "Version 1.0",
        "ApplicationName": {
          "Ref": "knlapiapp"
        },
        "SourceBundle": {
          "S3Bucket": {
            "Ref": "knlapiversionbucket"
          },
          "S3Key": {
            "Ref": "knlapiversionkey"
          }
        }
      }
    },

    "knlapienv": {
      "Type": "AWS::ElasticBeanstalk::Environment",
      "Properties": {
        "ApplicationName": {
          "Ref": "knlapiapp"
        },
        "EnvironmentName":{
          "Fn::Join": ["-", [{
              "Ref": "AWS::StackName"
            },
            "e"
          ]]
        },

        "Description": "Kornell API Environment",
        "SolutionStackName": "64bit Amazon Linux 2016.03 v2.1.0 running Java 8",        
        "VersionLabel": {
          "Ref": "knlapiversion"
        },
        "OptionSettings": [{
          "Namespace": "aws:ec2:vpc",
          "OptionName": "VPCId",
          "Value": {
            "Ref": "knlvpc"
          }
        }, {
          "Namespace": "aws:ec2:vpc",
          "OptionName": "Subnets",
          "Value": {
            "Ref": "knlapisubnetids"
          }
        }, {
          "Namespace": "aws:ec2:vpc",
          "OptionName": "ELBSubnets",
          "Value": {
            "Ref": "knlapisubnetids"
          }
        }, {
          "Namespace": "aws:elb:listener:443",
          "OptionName": "ListenerProtocol",
          "Value": "HTTPS"
        }, {
          "Namespace": "aws:elb:listener:443",
          "OptionName": "InstancePort",
          "Value": "8080"
        }, {
          "Namespace": "aws:elb:listener:443",
          "OptionName": "InstanceProtocol",
          "Value": "HTTP"
        },{
          "Namespace": "aws:elb:listener:443",
          "OptionName": "SSLCertificateId",
          "Value": {"Ref":"knlcertificateid"}
        },{
          "Namespace": "aws:autoscaling:launchconfiguration",
          "OptionName": "SecurityGroups",
          "Value": {
            "Ref": "knlapisgids"
          }
        },{
          "Namespace": "aws:ec2:vpc",
          "OptionName": "AssociatePublicIpAddress",
          "Value": "true"
        }, {
          "Namespace": "aws:elasticbeanstalk:application",
          "OptionName": "Application Healthcheck URL",
          "Value": "/api"
        }, {
          "Namespace": "aws:elasticbeanstalk:application:environment",
          "OptionName": "PORT",
          "Value": "8080"
        }, {
          "Namespace": "aws:elasticbeanstalk:application:environment",
          "OptionName": "JDBC_CONNECTION_STRING",
          "Value": {
            "Ref": "knljdbcurl"
          }
        }, {
          "Namespace": "aws:elasticbeanstalk:application:environment",
          "OptionName": "JDBC_USERNAME",
          "Value": {
            "Ref": "knljdbcusername"
          }
        }, {
          "Namespace": "aws:elasticbeanstalk:application:environment",
          "OptionName": "JDBC_PASSWORD",
          "Value": {
            "Ref": "knljdbcpassword"
          }
        }, {
          "Namespace": "aws:elasticbeanstalk:application:environment",
          "OptionName": "JDBC_DRIVER",
          "Value": {
            "Ref": "knljdbcdriver"
          }
        },  {
          "Namespace": "aws:autoscaling:launchconfiguration",
          "OptionName": "InstanceType",
          "Value": {
            "Ref": "knlapiinstancetype"
          }
        }, {
          "Namespace": "aws:autoscaling:launchconfiguration",
          "OptionName": "EC2KeyName",
          "Value": {
            "Ref": "knlkeypair"
          }
        }]
      }
    }
  },
  "Outputs" : {
    "knlapiendpoint": {
      "Description": "API_ENDPOINT",
      "Value": {
        "Fn::GetAtt": [ "knlapienv","EndpointURL"]
      }
    }
  }
}